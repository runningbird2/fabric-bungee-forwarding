name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      mod_version:
        description: "Mod version (defaults to tag name without v)"
        required: false

permissions:
  contents: write

jobs:
  build-and-publish:
    name: Build and publish (${{ matrix.minecraft }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        minecraft:
          - "1.21"
          - "1.21.1"
          - "1.21.2"
          - "1.21.3"
          - "1.21.4"
          - "1.21.5"
          - "1.21.6"
          - "1.21.7"
          - "1.21.8"
          - "1.21.9"
          - "1.21.10"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Resolve versions
        id: versions
        run: |
          declare -A FABRIC_MAP=(
            ["1.21"]="0.102.0+1.21"
            ["1.21.1"]="0.116.7+1.21.1"
            ["1.21.2"]="0.106.1+1.21.2"
            ["1.21.3"]="0.114.1+1.21.3"
            ["1.21.4"]="0.119.4+1.21.4"
            ["1.21.5"]="0.128.2+1.21.5"
            ["1.21.6"]="0.128.2+1.21.6"
            ["1.21.7"]="0.129.0+1.21.7"
            ["1.21.8"]="0.136.1+1.21.8"
            ["1.21.9"]="0.134.0+1.21.9"
            ["1.21.10"]="0.138.3+1.21.10"
          )

          MOD_VERSION="${{ github.event.inputs.mod_version || '' }}"
          if [ -z "${MOD_VERSION}" ]; then
            MOD_VERSION="${GITHUB_REF_NAME#v}"
          fi

          MC_VERSION="${{ matrix.minecraft }}"

          LOADER_VERSION="$(
            curl -s "https://meta.fabricmc.net/v2/versions/loader/${MC_VERSION}" \
            | jq -r '[.[] | select(.loader.stable == true)][0].loader.version'
          )"

          FABRIC_API_VERSION="$(
            curl -s "https://api.modrinth.com/v2/project/fabric-api/version?game_versions=[\"${MC_VERSION}\"]&loaders=[\"fabric\"]&featured=true" \
            | jq -r '.[0].version_number // empty'
          )"
          if [ -z "${FABRIC_API_VERSION}" ] || [ "${FABRIC_API_VERSION}" = "null" ]; then
            FABRIC_API_VERSION="$(
              curl -s "https://api.modrinth.com/v2/project/fabric-api/version?game_versions=[\"${MC_VERSION}\"]&loaders=[\"fabric\"]" \
              | jq -r '.[0].version_number'
            )"
          fi
          if [ -z "${FABRIC_API_VERSION}" ] || [ "${FABRIC_API_VERSION}" = "null" ]; then
            FABRIC_API_VERSION="${FABRIC_MAP[${MC_VERSION}]}"
          fi

          if [ -z "${FABRIC_API_VERSION}" ] || [ "${FABRIC_API_VERSION}" = "null" ]; then
            echo "Unable to resolve Fabric API for ${MC_VERSION}" >&2
            exit 1
          fi

          echo "mod=${MOD_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "mc=${MC_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "loader=${LOADER_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "fabric_api=${FABRIC_API_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "full_version=${MOD_VERSION}+${MC_VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF_NAME}"
          PREV_TAG="$(git tag --sort=-creatordate | grep -v "^${CURRENT_TAG}$" | head -n1)"
          if [ -z "${PREV_TAG}" ]; then
            FIRST_COMMIT="$(git rev-list --max-parents=0 HEAD)"
            RANGE="${FIRST_COMMIT}..HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          LOG="$(git log --pretty=format:'- %s' ${RANGE})"
          if [ -z "${LOG}" ]; then
            LOG="No changes since last tag."
          fi

          {
            echo "text<<EOF"
            echo "${LOG}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Build
        run: |
          ./gradlew clean build -x test \
            -Pmod_version=${{ steps.versions.outputs.mod }} \
            -Pminecraft_version=${{ matrix.minecraft }} \
            -Pfabric_version=${{ steps.versions.outputs.fabric_api }} \
            -Ploader_version=${{ steps.versions.outputs.loader }}

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: fabric-bungee
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: build/libs/fabric-bungee-forwarding-${{ steps.versions.outputs.full_version }}.jar
          name: Fabric Bungee Forwarding ${{ steps.versions.outputs.full_version }}
          version: ${{ steps.versions.outputs.full_version }}
          game-versions: ${{ matrix.minecraft }}
          loaders: fabric
          java: 21
          version-type: release
          changelog: ${{ steps.changelog.outputs.text }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fabric-bungee-forwarding-${{ steps.versions.outputs.full_version }}
          path: build/libs/fabric-bungee-forwarding-${{ steps.versions.outputs.full_version }}.jar
          if-no-files-found: error

  github-release:
    name: GitHub release
    runs-on: ubuntu-latest
    needs: build-and-publish
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          MOD_VERSION="${{ github.event.inputs.mod_version || '' }}"
          if [ -z "${MOD_VERSION}" ]; then
            MOD_VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "mod=${MOD_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${GITHUB_REF_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF_NAME}"
          PREV_TAG="$(git tag --sort=-creatordate | grep -v "^${CURRENT_TAG}$" | head -n1)"
          if [ -z "${PREV_TAG}" ]; then
            FIRST_COMMIT="$(git rev-list --max-parents=0 HEAD)"
            RANGE="${FIRST_COMMIT}..HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          LOG="$(git log --pretty=format:'- %s' ${RANGE})"
          if [ -z "${LOG}" ]; then
            LOG="No changes since last tag."
          fi

          {
            echo "text<<EOF"
            echo "${LOG}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: fabric-bungee-forwarding-*
          merge-multiple: true
          path: dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Fabric Bungee Forwarding ${{ steps.tag.outputs.mod }}
          body: ${{ steps.changelog.outputs.text }}
          files: dist/*.jar
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
